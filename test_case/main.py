import os
import json
import base64
import audioop
import re
from io import BytesIO

from google.genai import Client, types
from pydub import AudioSegment

DATABASE_FILENAME = "Database.json"

def load_database():
    if not os.path.exists(DATABASE_FILENAME):
        print(f"Le fichier {DATABASE_FILENAME} n'existe pas.")
        return {}
    with open(DATABASE_FILENAME, "r", encoding="utf-8") as f:
        return json.load(f)

def extract_call_conversation(call_id):

    db = load_database()
    for user, calls in db.get("users", {}).items():
        if call_id in calls:
            call_record = calls[call_id]
            conversation = call_record.get("conversation_log", [])
            return user, conversation
    return None, None

def convert_chunk_to_wav_bytes(audio_b64):

    try:
        ulaw_data = base64.b64decode(audio_b64)
    except Exception as e:
        print("Erreur lors du décodage base64:", e)
        return None

    try:
        linear_pcm = audioop.ulaw2lin(ulaw_data, 2)
    except Exception as e:
        print("Erreur lors de la conversion μ-law -> PCM:", e)
        return None

    segment = AudioSegment(
        data=linear_pcm,
        sample_width=2,   
        frame_rate=8000,   
        channels=1
    )

    buffer = BytesIO()
    segment.export(buffer, format="wav")
    wav_bytes = buffer.getvalue()
    return wav_bytes

def transcribe_conversation_with_gemini(conversation):

    client = Client(api_key="AIzaSyBs_CEsN0b8RnD9Wx6z5qvf_Jl0Kz3NGXk")
    transcript_lines = []
    for chunk in conversation:
        speaker = chunk.get("speaker", "unknown")
        timestamp = chunk.get("timestamp", "")
        audio_b64 = chunk.get("audio")
        if not audio_b64:
            continue
        wav_bytes = convert_chunk_to_wav_bytes(audio_b64)
        if wav_bytes is None:
            continue

        audio_part = types.Part.from_bytes(
            data=wav_bytes,
            mime_type="audio/wav"
        )
        prompt = f"Transcribe the following audio segment spoken by {speaker} (timestamp: {timestamp}):"
        try:
            response = client.models.generate_content(
                model="gemini-2.0-flash",
                contents=[prompt, audio_part]
            )
            transcript = response.text.strip()
        except Exception as e:
            print(f"Erreur lors de la transcription du chunk à {timestamp}: {e}")
            transcript = "[Erreur de transcription]"
        transcript_lines.append(f"{speaker.capitalize()} (t={timestamp}): {transcript}")
    return "\n".join(transcript_lines)

def main():
    call_id = "CA8e3cc56b5afe71f7c817f179d409a673"
    user, conversation = extract_call_conversation(call_id)
    if conversation is None:
        print(f"Call ID {call_id} non trouvé dans la base de données.")
        return

    print(f"Transcription de la conversation pour le call ID {call_id} (utilisateur: {user}) :\n")
    transcript = transcribe_conversation_with_gemini(conversation)
    print("=== Transcription complète ===")
    print(transcript)

if __name__ == "__main__":
    main()












































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































